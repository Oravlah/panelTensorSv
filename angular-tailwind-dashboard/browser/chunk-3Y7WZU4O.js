import{a as c}from"./chunk-FOI7S34C.js";import{b as T}from"./chunk-HRXG5HTB.js";import{k as a,m as k}from"./chunk-TBJE3TRH.js";import{B as d,U as f,Y as u,ba as p,j as l,n as h}from"./chunk-XKZZ5MB7.js";var i=class extends Error{};i.prototype.name="InvalidTokenError";function E(o){return decodeURIComponent(atob(o).replace(/(.)/g,(r,n)=>{let e=n.charCodeAt(0).toString(16).toUpperCase();return e.length<2&&(e="0"+e),"%"+e}))}function m(o){let r=o.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return E(r)}catch{return atob(r)}}function I(o,r){if(typeof o!="string")throw new i("Invalid token specified: must be a string");r||(r={});let n=r.header===!0?0:1,e=o.split(".")[n];if(typeof e!="string")throw new i(`Invalid token specified: missing part #${n+1}`);let t;try{t=m(e)}catch(s){throw new i(`Invalid token specified: invalid base64 for part #${n+1} (${s.message})`)}try{return JSON.parse(t)}catch(s){throw new i(`Invalid token specified: invalid json for part #${n+1} (${s.message})`)}}var x=(()=>{let r=class r{constructor(e,t){this.httpClient=e,this.router=t,this.isUserLogin=new l(this.hasToken()),this.userInfo=new l(null),this.REST_API_AUTH_REGISTER=c.REST_API_AUTH_REGISTER,this.REST_API_AUTH=c.REST_API_AUTH,this.REST_API_USERS=c.REST_API_USERS,this.monitorTokenChanges(),this.hasToken()&&this.loadUserInfo()}loadUserInfo(){let e=this.getToken();if(e&&this.validateToken()){let t=new a().set("Authorization",`Bearer ${e}`);this.httpClient.get(this.REST_API_USERS,{headers:t}).pipe(d(this.handleError)).subscribe(s=>{this.userInfo.next(s)})}else this.userInfo.next(null)}deleteUser(){let e=this.getToken();if(!e)return h(()=>new Error("No token found"));let t=new a().set("Authorization",`Bearer ${e}`);return this.httpClient.delete(this.REST_API_USERS,{headers:t}).pipe(f(()=>this.logout()),d(this.handleError))}register(e){return this.httpClient.post(this.REST_API_AUTH_REGISTER,e,{headers:new a({"Content-Type":"application/json"})})}login(e){return this.httpClient.post(this.REST_API_AUTH,e,{headers:new a({"Content-Type":"application/json"})}).pipe(f(t=>{localStorage.setItem("access_token",t.access),localStorage.setItem("refresh_token",t.refresh),this.isUserLogin.next(!0),this.loadUserInfo()}))}getToken(){return localStorage.getItem("access_token")}hasToken(){return!!this.getToken()}isLoggedIn(){let e=this.hasToken();return this.isUserLogin.next(e),e}logout(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),this.isUserLogin.next(!1),this.userInfo.next(null),this.router.navigate(["/login"])}validateToken(){let e=this.getToken();if(!e)return!1;try{let s=I(e).exp,g=Math.floor(new Date().getTime()/1e3)>s;return g&&this.logout(),!g}catch{return this.logout(),!1}}getUserInfo(){let e=this.getToken();if(!e)return h(()=>new Error("No token found"));let t=new a().set("Authorization",`Bearer ${e}`);return this.httpClient.get(this.REST_API_USERS,{headers:t})}monitorTokenChanges(){window.addEventListener("storage",e=>{(e.key==="access_token"||e.key==="refresh_token")&&(this.getToken()||(this.isUserLogin.next(!1),this.userInfo.next(null),this.router.navigate(["/login"])))})}handleError(e){let t="";return e.error instanceof ErrorEvent?t=e.error.message:t=`Error Code: ${e.status}. Message: ${e.message}`,h(()=>new Error(t))}};r.\u0275fac=function(t){return new(t||r)(p(k),p(T))},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();export{x as a};
